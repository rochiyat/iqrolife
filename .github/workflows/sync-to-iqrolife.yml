name: Sync to Iqrolife Repository

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      
      - name: Configure Git
        run: |
          git config --global user.name "Rochiyat"
          git config --global user.email "rochiyat@gmail.com"
      
      - name: Prepare clean branch with history
        run: |
          # Fetch all branches
          git fetch --all
          
          # Check if clean-main exists locally, if not create it from main
          if git show-ref --verify --quiet refs/heads/clean-main; then
            git checkout clean-main
            git merge main --no-edit -m "Merge latest changes from main - $(date '+%Y-%m-%d %H:%M:%S')"
          else
            # Create clean-main from main (preserving history)
            git checkout -b clean-main main
          fi
      
      - name: Add target repository as remote
        run: |
          git remote add target https://${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/iqrolife/iqrolife.git || true
      
      - name: Push to target repository
        run: |
          # Push with history preserved (remove --force to keep history)
          git push target clean-main:sandbox
      
      - name: Notify completion
        if: success()
        run: echo "âœ… Successfully synced to iqrolife/iqrolife with clean history"
